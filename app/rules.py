from app.schemas import Analysis
from typing import Dict, List

DISCLAIMER = """
הערת אחריות משפטית:
המידע המוצג הוא להכוונה ראשונית בלבד ואינו מהווה ייעוץ משפטי רשמי.
מומלץ להתייעץ עם עורך דין מוסמך לפני נקיטת צעדים משפטיים.
"""

# מאגר משאבים משפטיים
LEGAL_RESOURCES: Dict[str, List[str]] = {
    "קניות_אונליין": [
        "חוק הגנת הצרכן, התשמ\"א-1981",
        "אתר רשות הגנת הצרכן: https://www.gov.il/he/departments/guides/consumer_protection",
        "קו חם: *2579",
        "טופס תלונה: https://www.gov.il/he/service/consumer_complaint",
        "מדריך זכויות צרכן בקניות מרחוק"
    ],
    
    "שכירות": [
        "חוק השכירות והשאילה, התשל\"ב-1972",
        "טקסט החוק: https://www.nevo.co.il/law_html/law01/158_001.htm",
        "משרד הבינוי והשיכון: https://www.gov.il/he/departments/guides/housing_rights",
        "בתי משפט לשכירות: https://www.gov.il/he/departments/guides/rent_tribunals",
        "מדריך החזרת פיקדון"
    ],
    
    "פרטיות": [
        "חוק הגנת הפרטיות, התשמ\"א-1981",
        "טקסט החוק: https://www.nevo.co.il/law_html/law01/286_001.htm",
        "רשות הגנת הפרטיות: https://www.gov.il/he/departments/the_privacy_protection_authority",
        "טלפון: 02-6529808",
        "טופס תלונה על הפרת פרטיות",
        "מדריך זכויות הפרט"
    ],
    
    "חוזים": [
        "חוק החוזים (חלק כללי), התשל\"ג-1973",
        "טקסט החוק: https://www.nevo.co.il/law_html/law01/056_001.htm",
        "חוק תרופות בשל הפרת חוזה, התשל\"א-1970",
        "תביעות קטנות: https://www.gov.il/he/departments/guides/small_claims",
        "לשכת עורכי הדין: https://www.israelbar.org.il",
        "שירותי גישור"
    ],
    
    "נזקים_כספיים": [
        "פקודת הנזיקין, התשכ\"ח-1968",
        "טקסט החוק: https://www.nevo.co.il/law_html/law01/192_001.htm",
        "תביעות קטנות (עד 37,700 ₪): https://www.gov.il/he/departments/guides/small_claims",
        "מדריך הליכי בית משפט אזרחי",
        "דיווח על הונאה: משטרה 100",
        "רשות המסים - חקירות"
    ],
    
    "עבודה_ותעסוקה": [
        "חוק יסוד העבודה",
        "חוק הודעה מוקדמת לפיטורים, התשס\"א-2001",
        "משרד העבודה: https://www.gov.il/he/departments/topics/employees_rights",
        "מרכז מידע לעובד: *6354",
        "בתי דין לעבודה: https://www.gov.il/he/departments/guides/labor_courts",
        "ההסתדרות - ייעוץ משפטי",
        "מדריך זכויות עובדים זרים"
    ],
    
    "אחר": [
        "לשכת עורכי הדין: https://www.israelbar.org.il",
        "מערכת בתי המשפט: https://www.gov.il/he/departments/guides/court_system",
        "סיוע משפטי: https://www.gov.il/he/departments/legal_aid",
        "קו סיוע משפטי: *3852",
        "מרכז מידע זכויות אדם",
        "עמותות זכויות אזרח"
    ]
}

def get_recommendation(analysis: Analysis) -> str:
    """יצירת המלצה פרוצדורלית מפורטת"""
    
    recommendations = {
        "קניות_אונליין": {
            "נמוכה": """צעדים מומלצים:

שלב 1 - פנייה ישירה:
1. פנה בכתב לשירות לקוחות (מייל/וואטסאפ)
2. תאר את הבעיה בצירוף מספר הזמנה
3. שמור כל התכתובת
4. תן זמן סביר לתגובה (7-14 יום)

מסמכים נדרשים:
- חשבונית/קבלה
- צילומי מסך
- תמונות מוצר פגום
- אישור תשלום""",

            "בינונית": """צעדים מומלצים:

שלב 1 - הסלמה רשמית:
1. שלח תלונה רשמית בדואר רשום
2. פרט את הדרישות (החזר/החלפה/פיצוי)
3. קבע מועד אחרון (14 יום)

שלב 2 - התערבות רשמית:
4. הגש תלונה לרשות הגנת הצרכן (*2579)
5. צרף כל המסמכים
6. עקוב אחר התלונה

שלב 3 - הליכים משפטיים:
7. שקול תביעה קטנה
8. איסוף ראיות נוספות
9. התייעץ עם עורך דין צרכנות""",

            "גבוהה": """אזהרה: הנושא דורש טיפול משפטי מיידי

מצבים הדורשים עורך דין:
- סכומים גדולים (מעל 10,000 ₪)
- נזקים חמורים או סכנה בריאותית
- סירוב מוחלט של החברה
- חלפו המועדים לתלונה

צעדים דחופים:
1. תעד הכל מיד
2. שלח התראה משפטית
3. שקול צו מניעה זמני
4. התכונן להליך משפטי"""
        },
        
        "שכירות": {
            "נמוכה": """צעדים מומלצים:

צעדים ראשוניים:
1. עיין בסעיפי החוזה הרלוונטיים
2. תעד את הבעיה (תמונות, תאריכים)
3. שלח מכתב כתוב לבעל הבית/שוכר

שיטות עבודה מומלצות:
- השתמש בערוצי תקשורת מתועדים
- שמור כל התכתובת
- תעד הסכמות בעל פה בכתב
- תן זמן סביר לפתרון (7-14 יום)""",

            "בינונית": """צעדים מומלצים:

שלב 1 - ניסיונות פשרה:
1. נסה גישור באמצעות צד שלישי
2. הצע פתרונות פשרה סבירים
3. תעד את כל הניסיונות

שלב 2 - הסלמה משפטית:
4. שלח התראה רשמית דרך עורך דין
5. פרט את הדרישות המשפטיות
6. קבע מועד אחרון

שלב 3 - הליכים משפטיים:
7. הגש תביעה לבית משפט לשכירות
8. הגש כל הראיות והמסמכים
9. השתתף בדיונים ועקוב

הערה: לתיקי שכירות יש מועדים משפטיים קפדניים""",

            "גבוהה": """אזהרה דחופה: דורש טיפול משפטי מיידי

מצבים קריטיים:
- הליכי פינוי כפוי
- מחלוקות על בעלות
- סכומים גדולים שנוי במחלוקת
- הפרות חמורות של החוזה

צעדים דחופים:
1. התייעץ עם עורך דין שכירות מיד
2. אסוף את כל המסמכים
3. אל תנקוט צעדים חד-צדדיים לפני ייעוץ
4. שקול צו מניעה זמני

אזהרה: איחור עלול לגרום לאובדן זכויות"""
        },
        
        "פרטיות": {
            "נמוכה": """צעדים מומלצים:

תיעוד מיידי:
1. צלם צילומי מסך של תוכן פוגעני
2. תעד תאריכים ושעות מדויקות
3. שמור כל התכתובת הרלוונטית
4. תעד כל נזק שנגרם

צעדים ראשוניים:
5. בקש הסרה מיידית של התוכן
6. שמור עותקי גיבוי של כל הראיות
7. אל תגיב ישירות לתוכן
8. דווח לפלטפורמה הרלוונטית""",

            "בינונית": """צעדים מומלצים:

שלב 1 - הסלמה רשמית:
1. הגש תלונה לרשות הגנת הפרטיות
2. מלא את הטופס האלקטרוני
3. צרף כל הראיות

שלב 2 - הליכים משפטיים:
4. שלח התראה רשמית למפר
5. דרוש הסרת תוכן מיידית
6. תעד נזקים חומריים ומוסריים

שלב 3 - מעקב:
7. עקוב אחר התלונה ברשות
8. שקול תביעת נזיקין
9. שקול תלונה פלילית (בעבירות סייבר)""",

            "גבוהה": """אזהרה: מצב חמור הדורש טיפול מיידי

מצבים חריגים:
- סחיטה אלקטרונית
- לשון הרע חמור
- דליפת מידע רגיש מאוד
- איומים אישיים

צעדים דחופים:
1. פנה למשטרה מיד (100) במקרי סחיטה
2. התייעץ עם עורך דין סייבר
3. בקש צו הסרה דחוף
4. שקול הגנה משפטית

אזהרה: אל תנהל משא ומתן עם סוחטים
שמור כל הראיות ואל תמחק שיחות"""
        },
        
        "חוזים": {
            "נמוכה": """צעדים מומלצים:

שלב בדיקה:
1. קרא את כל החוזה וזהה את הסעיפים הרלוונטיים
2. זהה את ההתחייבויות של כל צד
3. זהה את הסעיף המופר במדויק

שלב תקשורת:
4. שלח מכתב כתוב לצד השני
5. הפנה לסעיפים ספציפיים
6. בקש ביצוע או תיקון בבירור
7. תן זמן סביר (לפחות 14 יום)

תיעוד:
- שמור עותק מקור של החוזה
- תעד כל התכתובת
- שמור מסמכים תומכים""",

            "בינונית": """צעדים מומלצים:

שלב 1 - הסלמה רשמית:
1. שלח הודעה רשמית על הפרת חוזה
2. פרט את הנזקים והתביעות
3. בקש פתרון בתוך מועד מוגדר

שלב 2 - גישור:
4. הצע גישור או פשרה
5. הצע פתרונות פשרה סבירים
6. תעד כל ההצעות והתגובות

שלב 3 - הליכים משפטיים:
7. התייעץ עם עורך דין חוזים
8. שלח התראה משפטית רשמית
9. התכונן לתביעה אפשרית
10. אסוף ראיות על ההפרה והנזקים""",

            "גבוהה": """אזהרה: נושא חוזי מורכב הדורש ייעוץ משפטי

סימנים למורכבות:
- חוזים מסחריים גדולים או מורכבים
- סכומים כספיים גדולים
- מספר צדדים מעורבים
- סעיפים משפטיים מורכבים
- מחלוקות על פירוש החוזה

צעדים מומלצים:
1. אל תנקוט צעדים לפני ייעוץ משפטי
2. אסוף את כל המסמכים
3. הכן ציר זמן של אירועים
4. תעד כל נזק כספי ואחר
5. התייעץ עם עורך דין חוזים מיד

הערה: טעויות בטיפול בחוזים יכולות לעלות ביוקר"""
        },
        
        "נזקים_כספיים": {
            "נמוכה": """צעדים מומלצים:

שלב תיעוד:
1. אסוף כל המסמכים הכספיים
2. הכן חישוב מדויק של הנזקים
3. תעד תכתובת קודמת

שלב תביעה:
4. שלח תביעה כתובה ברורה לפיצוי
5. צרף מסמכים תומכים
6. קבע מועד סביר לתגובה ותשלום (14-30 יום)
7. שמור עותקים מכל התכתובת""",

            "בינונית": """צעדים מומלצים:

הערכת התביעה:
- סכום מתחת ל-37,700 ₪: תביעה קטנה
- סכום מעל: תביעה אזרחית רגילה

לתביעות קטנות:
1. מלא טופס תביעה קטנה
2. שלם אגרה (כ-2.5% מהסכום)
3. הגש ראיות בכתב
4. השתתף בדיון
5. קבל פסק דין לביצוע

לסכומים גדולים יותר:
1. התייעץ עם עורך דין להערכה
2. שלח התראה משפטית רשמית
3. שקול הליכי עיקול נכסים
4. הגש תביעה בבית המשפט המתאים""",

            "גבוהה": """אזהרה: נושא כספי חמור הדורש טיפול מיידי

מצבים דחופים:
- סכומים גדולים (מעל 100,000 ₪)
- סכנה לבריחת חייב או הסתרת נכסים
- פשעי הונאה או רמאות
- הפרות אמון חמורות

צעדים דחופים:
1. התייעץ עם עורך דין פיננסי מיד
2. שקול בקשה לעיקול נכסים זמני
3. הגש תלונה למשטרה (במקרי הונאה פלילית)
4. אסוף כל הראיות הכספיות
5. תעד כל העסקאות והתקשורת

הערה חשובה: איחור עלול להקשות על החזרת כספים"""
        },
        
        "עבודה_ותעסוקה": {
            "נמוכה": """צעדים מומלצים:

שלב בדיקה:
1. עיין בחוזה העבודה ונספחיו
2. בדוק תלושי שכר ומסמכים רלוונטיים
3. זהה את הזכות או החובה השנויה במחלוקת

שלב תקשורת:
4. הגש בקשה כתובה להנהלה/משאבי אנוש
5. הסבר את הדרישה בצירוף בסיס משפטי
6. תן זמן סביר לתגובה (7-14 יום)
7. שמור עותקים מכל התכתובת

תיעוד חשוב:
- חוזה עבודה מקורי
- תלושי שכר
- כל שינויים או נספחים
- תכתובת רשמית""",

            "בינונית": """צעדים מומלצים:

שלב 1 - הסלמה פנימית:
1. הגש תלונה רשמית להנהלה הבכירה
2. בקש פגישה לדיון בנושא
3. תעד כל השיחות והתוצאות

שלב 2 - התערבות חיצונית:
4. הגש תלונה למשרד העבודה (*6354)
5. בקש התערבות מפקח עבודה
6. פנה לארגון עובדים (אם קיים)

שלב 3 - הליכים משפטיים:
7. התייעץ עם עורך דין עבודה
8. שלח התראה משפטית
9. שקול הגשת תביעה לבית דין לעבודה

הערה: דיני עבודה מגינים על עובדים, אל תהסס לתבוע זכויות""",

            "גבוהה": """אזהרה דחופה: נושא עבודה חמור הדורש טיפול מיידי

מצבים קריטיים:
- פיטורים שלא כדין
- אפליה או הטרדה במקום עבודה
- אי תשלום שכר לתקופות ארוכות
- הפרות חמורות של תנאי עבודה

צעדים דחופים:
1. התייעץ עם עורך דין עבודה מיד
2. אל תחתום על מסמכים לפני ייעוץ
3. תעד כל האירועים בדיוק (תאריכים, עדים, מסמכים)
4. הגש תלונה למשרד העבודה
5. שקול תביעה דחופה לבית דין

אזהרה חשובה:
- יש לך מועדים משפטיים מוגבלים (בדרך כלל 60 יום לתלונה על פיטורים)
- אל תאחר בנקיטת צעדים
- שמור את כל המסמכים המקוריים"""
        }
    }
    
    category_recs = recommendations.get(analysis.category, {})
    recommendation = category_recs.get(
        analysis.complexity,
        """מומלץ לספק מידע מפורט יותר לקביעת המסלול המתאים:

מידע נדרש:
- תאריכים מדויקים של אירועים
- סכומים כספיים רלוונטיים (אם יש)
- שמות ופרטי הצדדים המעורבים
- מסמכים או ראיות זמינות
- צעדים שננקטו בעבר (אם יש)"""
    )
    
    return recommendation

def get_legal_resources(category: str) -> str:
    """קבלת רשימת משאבים משפטיים לפי קטגוריה"""
    resources = LEGAL_RESOURCES.get(category, LEGAL_RESOURCES["אחר"])
    
    formatted_resources = []
    for idx, resource in enumerate(resources, 1):
        formatted_resources.append(f"{idx}. {resource}")
    
    return "\n".join(formatted_resources)

def format_reply(analysis: Analysis, include_resources: bool = False) -> str:
    """עיצוב תשובה מלאה למשתמש"""
    
    confidence_level = (
        "גבוהה" if analysis.confidence > 0.75
        else "בינונית" if analysis.confidence > 0.5
        else "נמוכה"
    )
    
    reply = f"""תוצאות הניתוח

סיווג: {analysis.category.replace('_', ' ')}
רמת מורכבות: {analysis.complexity}
רמת דיוק: {confidence_level} ({int(analysis.confidence * 100)}%)

סיכום:
{analysis.summary}
"""
    
    if analysis.missing_info and len(analysis.missing_info) > 0:
        reply += "\n\nמידע נוסף שיכול לשפר את ההערכה:\n"
        for info in analysis.missing_info:
            reply += f"  • {info}\n"
    
    reply += "\n\nהמלצות לפעולה:\n"
    reply += get_recommendation(analysis)
    
    if include_resources:
        reply += "\n\nמשאבים משפטיים:\n"
        reply += get_legal_resources(analysis.category)
    
    reply += f"\n\n{DISCLAIMER}"
    
    return reply